# Dual-UNet CF-FA Generation Model (v27)

## ğŸ“‹ æ ¸å¿ƒæ”¹è¿›

### é—®é¢˜è¯Šæ–­

**v23/v24/v26 å¤±è´¥çš„æ ¹æœ¬åŸå› :**

1. **Shared Self-Attention çš„è‡´å‘½ç¼ºé™·**: FAåˆ†æ”¯å…±äº«CFåˆ†æ”¯çš„attention map,å¯¼è‡´FAå®Œå…¨å¤±å»è‡ªèº«ç»“æ„ç‰¹å¾,åªèƒ½ç”Ÿæˆå™ªç‚¹
2. **å¼ºåˆ¶è€¦åˆé—®é¢˜**: å°†CFå’ŒFAç”¨åŒä¸€å™ªå£°ã€åŒä¸€timestepã€åŒä¸€UNetå¤„ç†,ä½†ä¸¤è€…åˆ†å¸ƒå·®å¼‚å·¨å¤§(å½©è‰² vs é»‘ç™½é«˜å¯¹æ¯”åº¦)
3. **åˆ†è¾¨ç‡ä¸è¶³**: v25ä½¿ç”¨256x512å‹ç¼©æ‹¼æ¥,åˆ†è¾¨ç‡å¤ªä½,è¡€ç®¡ç»“æ„æ¨¡ç³Š

### v27 è§£å†³æ–¹æ¡ˆ

âœ… **åŒUNetæ¶æ„**: ä¸ºCFå’ŒFAåˆ†åˆ«ä½¿ç”¨ç‹¬ç«‹çš„UNet+LoRA,ä¿æŒå„è‡ªçš„çº¹ç†å’Œäº®åº¦åˆ†å¸ƒç‰¹å¾

âœ… **è§£è€¦è®­ç»ƒ**: CFå’ŒFAä½¿ç”¨ä¸åŒçš„å™ªå£°å’Œtimestep,é¿å…å¼ºåˆ¶è€¦åˆ

âœ… **ç»“æ„ä¸€è‡´æ€§çº¦æŸ**: åœ¨latent spaceé€šè¿‡Sobelæ¢¯åº¦æå–ç»“æ„å›¾,æ·»åŠ L1æŸå¤±ç¡®ä¿CF-FAè¡€ç®¡ç»“æ„å¯¹é½

âœ… **512x512å…¨åˆ†è¾¨ç‡**: ç›´æ¥åœ¨512x512åˆ†è¾¨ç‡è®­ç»ƒå’Œç”Ÿæˆ

âœ… **å»é™¤Shared Self-Attention**: å®Œå…¨ç§»é™¤è¿™ä¸ªæœ‰å®³æœºåˆ¶

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
è®­ç»ƒé˜¶æ®µ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  çœŸå®CF-FAé…å¯¹æ•°æ®                                    â”‚
â”‚  (512x512, å·²é…å‡†)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                      â”‚
           â–¼                      â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ VAEç¼–ç   â”‚           â”‚ VAEç¼–ç   â”‚
    â”‚  CFâ†’lat  â”‚           â”‚  FAâ†’lat  â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
          â”‚                      â”‚
          â–¼                      â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ åŠ å™ªå£°t1 â”‚           â”‚ åŠ å™ªå£°t2 â”‚
    â”‚ (ç‹¬ç«‹)   â”‚           â”‚ (ç‹¬ç«‹)   â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
          â”‚                      â”‚
          â–¼                      â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ UNet-CF  â”‚           â”‚ UNet-FA  â”‚
    â”‚ + LoRA   â”‚           â”‚ + LoRA   â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
          â”‚                      â”‚
          â–¼                      â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ å™ªå£°é¢„æµ‹ â”‚           â”‚ å™ªå£°é¢„æµ‹ â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
          â”‚                      â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          â”‚          â”‚           â”‚
          â–¼          â–¼           â–¼
     Loss_CF    Loss_FA   Loss_Struct
     (MSE+HF)   (MSE+HF)  (ç»“æ„ä¸€è‡´æ€§)
          â”‚          â”‚           â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
                Total Loss
```

ç”Ÿæˆé˜¶æ®µ:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  çº¯å™ªå£° z0       â”‚
â”‚  (åŒä¸€åˆå§‹åŒ–)    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
     â”‚         â”‚
     â–¼         â–¼
 lat_cf    lat_fa
     â”‚         â”‚
     â–¼         â–¼
 UNet-CF   UNet-FA
  (å»å™ª)    (å»å™ª)
     â”‚         â”‚
     â–¼         â–¼
 VAEè§£ç    VAEè§£ç 
     â”‚         â”‚
     â–¼         â–¼
   CFå›¾      FAå›¾
 (512x512) (512x512)
```

## ğŸ“Š æŸå¤±å‡½æ•°

```python
# å•æ¨¡æ€æŸå¤± (CFå’ŒFAå„è‡ªè®¡ç®—)
Loss_modality = MSE(noise_pred, noise) + Î»_hf * HF_Loss(pred_x0, gt_x0)

# ç»“æ„ä¸€è‡´æ€§æŸå¤±
struct_cf = Sobel_Gradient(pred_x0_cf)
struct_fa = Sobel_Gradient(pred_x0_fa)
Loss_struct = L1(struct_cf, struct_fa)

# æ€»æŸå¤±
Loss_total = Loss_CF + Loss_FA + Î»_struct * Loss_struct
```

**å…³é”®å‚æ•°:**
- `Î»_hf = 0.5`: é«˜é¢‘çº¹ç†æŸå¤±æƒé‡
- `Î»_struct = 0.3`: ç»“æ„ä¸€è‡´æ€§æŸå¤±æƒé‡

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. è®­ç»ƒ

```bash
cd /data/student/Fengjunming/SDXL_ControlNet/Scripts_v2/v27

# åŸºç¡€è®­ç»ƒ
python train.py \
  --name 260224_dual_unet_v27 \
  --max_steps 15000 \
  --unet_lora_rank 16 \
  --unet_lora_alpha 16 \
  --hf_lambda 0.5 \
  --struct_lambda 0.3 \
  --offset_noise_strength 0.1

# å¦‚æœæ˜¾å­˜å……è¶³,å¯ä»¥å°è¯•æ›´å¤§çš„LoRA rank
python train.py \
  --name 260224_dual_unet_v27_rank32 \
  --max_steps 15000 \
  --unet_lora_rank 32 \
  --unet_lora_alpha 32 \
  --hf_lambda 0.5 \
  --struct_lambda 0.5 \
  --offset_noise_strength 0.1
```

### 2. ç”Ÿæˆæµ‹è¯•

ä½¿ç”¨best checkpointç”Ÿæˆå›¾åƒ:

```bash
# ç”Ÿæˆ10ç»„CF-FAé…å¯¹
python test_gen.py \
  --checkpoint_dir /data/student/Fengjunming/SDXL_ControlNet/results/out_dual_unet_cffa_v27/260224_dual_unet_v27/best_checkpoint \
  --num_samples 10 \
  --steps 50 \
  --seed 42

# ç”Ÿæˆ100ç»„ç”¨äºæ‰©å……æ•°æ®é›†
python test_gen.py \
  --checkpoint_dir /data/student/Fengjunming/SDXL_ControlNet/results/out_dual_unet_cffa_v27/260224_dual_unet_v27/best_checkpoint \
  --num_samples 100 \
  --steps 50 \
  --output_dir /data/student/Fengjunming/SDXL_ControlNet/data/generated_cffa_v27
```

### 3. ç›‘æ§è®­ç»ƒ

è®­ç»ƒè¿‡ç¨‹ä¸­ä¼šè‡ªåŠ¨ä¿å­˜:
- `training_log.txt`: è®­ç»ƒæŸå¤±æ—¥å¿—
- `validation_log.txt`: éªŒè¯æŸå¤±æ—¥å¿—
- `step_XXXXXX_random_pairs/`: æ¯500æ­¥ç”Ÿæˆ10ç»„å¯è§†åŒ–æ ·æœ¬
- `best_checkpoint/`: æœ€ä½³æ¨¡å‹æƒé‡
- `latest_checkpoints/`: æœ€è¿‘3ä¸ªcheckpoint (æ»šåŠ¨ä¿å­˜)

## ğŸ” å…³é”®åˆ›æ–°ç‚¹

### 1. ç‹¬ç«‹åŒUNetæ¶æ„

**ä¸ºä»€ä¹ˆä¸ç”¨å•UNet?**
- CFæ˜¯å½©è‰²å›¾åƒ,FAæ˜¯é»‘ç™½é«˜å¯¹æ¯”åº¦å›¾åƒ
- ä¸¤è€…çš„åˆ†å¸ƒã€çº¹ç†ã€äº®åº¦èŒƒå›´å®Œå…¨ä¸åŒ
- å¼ºè¡Œç”¨åŒä¸€å¥—å‚æ•°å¤„ç†ä¼šå¯¼è‡´æ¨¡å‹æ— æ³•æ”¶æ•›

**åŒUNetçš„ä¼˜åŠ¿:**
- æ¯ä¸ªæ¨¡æ€æœ‰è‡ªå·±çš„LoRAå‚æ•°ç©ºé—´
- å¯ä»¥å­¦ä¹ å„è‡ªç‹¬ç‰¹çš„çº¹ç†å’Œé£æ ¼
- è®­ç»ƒæ›´ç¨³å®š,æ”¶æ•›æ›´å¿«

### 2. ç»“æ„ä¸€è‡´æ€§çº¦æŸ

**ä¸ºä»€ä¹ˆéœ€è¦?**
- åŒUNetç‹¬ç«‹è®­ç»ƒå¯èƒ½å¯¼è‡´CFå’ŒFAçš„è¡€ç®¡ç»“æ„ä¸ä¸€è‡´
- éœ€è¦æ˜¾å¼çº¦æŸç¡®ä¿ç»“æ„å¯¹é½

**å¦‚ä½•å®ç°?**
- ä½¿ç”¨Sobelç®—å­åœ¨latent spaceæå–æ¢¯åº¦/è¾¹ç¼˜ä½œä¸ºç»“æ„è¡¨ç¤º
- å¯¹CFå’ŒFAçš„ç»“æ„å›¾è®¡ç®—L1æŸå¤±
- åœ¨é¢„æµ‹çš„x0ä¸Šè®¡ç®—(è€ŒéåŠ å™ªåçš„latent)

### 3. è§£è€¦è®­ç»ƒç­–ç•¥

**v26çš„é—®é¢˜:**
```python
# v26: CFå’ŒFAå¼ºåˆ¶è€¦åˆ
noise = torch.randn_like(lat_cf)  # åŒä¸€å™ªå£°
timesteps = torch.randint(...)     # åŒä¸€timestep
lat_all = torch.cat([lat_cf_t, lat_fa_t], dim=0)  # æ‹¼æ¥é€å…¥åŒä¸€UNet
```

**v27çš„æ”¹è¿›:**
```python
# v27: CFå’ŒFAç‹¬ç«‹è®­ç»ƒ
noise_cf = torch.randn_like(lat_cf)  # CFç‹¬ç«‹å™ªå£°
noise_fa = torch.randn_like(lat_fa)  # FAç‹¬ç«‹å™ªå£°
timesteps_cf = torch.randint(...)     # CFç‹¬ç«‹timestep
timesteps_fa = torch.randint(...)     # FAç‹¬ç«‹timestep
# åˆ†åˆ«é€å…¥å„è‡ªçš„UNet
```

### 4. ä»åŒä¸€å™ªå£°åˆå§‹åŒ–ç”Ÿæˆ

**ç”Ÿæˆæ—¶çš„ç­–ç•¥:**
- è®­ç»ƒæ—¶: CFå’ŒFAä½¿ç”¨ä¸åŒå™ªå£°(è§£è€¦)
- ç”Ÿæˆæ—¶: ä»åŒä¸€ä¸ªz0åˆå§‹åŒ–(ä¿è¯åˆå§‹ç»“æ„ç›¸ä¼¼)
- å»å™ªè¿‡ç¨‹: å„è‡ªç‹¬ç«‹å»å™ª,é€šè¿‡è®­ç»ƒæ—¶å­¦åˆ°çš„ç»“æ„ä¸€è‡´æ€§è‡ªç„¶å¯¹é½

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

ç›¸æ¯”v26,v27åº”è¯¥èƒ½å¤Ÿ:

âœ… **FAå›¾ä¸å†æ˜¯å™ªç‚¹**: æ¯ä¸ªæ¨¡æ€æœ‰ç‹¬ç«‹UNet,FAèƒ½å­¦ä¹ è‡ªå·±çš„ç‰¹å¾

âœ… **è¡€ç®¡ç»“æ„æ¸…æ™°**: 512x512å…¨åˆ†è¾¨ç‡ + ç»“æ„ä¸€è‡´æ€§çº¦æŸ

âœ… **çº¹ç†çœŸå®**: é«˜é¢‘æŸå¤± + offset noise + ç‹¬ç«‹å»ºæ¨¡

âœ… **CF-FAç»“æ„å¯¹é½**: ç»“æ„ä¸€è‡´æ€§æŸå¤±ç¡®ä¿é…å¯¹å…³ç³»

âœ… **è®­ç»ƒç¨³å®š**: è§£è€¦è®­ç»ƒé¿å…æ¨¡æ€å†²çª

## ğŸ¯ åç»­ä¼˜åŒ–æ–¹å‘

å¦‚æœv27æ•ˆæœä»ä¸ç†æƒ³,å¯ä»¥å°è¯•:

1. **è°ƒæ•´ç»“æ„ä¸€è‡´æ€§æƒé‡**: `--struct_lambda 0.5` æˆ– `0.7`
2. **å¢å¤§LoRA rank**: `--unet_lora_rank 32` æˆ– `64`
3. **æ›´å¤šè®­ç»ƒæ­¥æ•°**: `--max_steps 30000`
4. **è°ƒæ•´å»å™ªæ­¥æ•°**: ç”Ÿæˆæ—¶ä½¿ç”¨ `--steps 100` (æ›´æ…¢ä½†è´¨é‡æ›´å¥½)
5. **æ·»åŠ æ„ŸçŸ¥æŸå¤±**: åœ¨åƒç´ ç©ºé—´æ·»åŠ LPIPSæŸå¤±(éœ€è¦ä¿®æ”¹ä»£ç )

## ğŸ“ ä¸å…¶ä»–ç‰ˆæœ¬å¯¹æ¯”

| ç‰ˆæœ¬ | æ¶æ„ | åˆ†è¾¨ç‡ | ä¸»è¦é—®é¢˜ | v27æ”¹è¿› |
|------|------|--------|----------|---------|
| v22 | ControlNet | 512x512 | æ¡ä»¶ç”Ÿæˆ,éæ— æ¡ä»¶ç”Ÿæˆ | æ”¹ä¸ºæ— æ¡ä»¶ç”Ÿæˆ |
| v23/v24 | å•UNet+SSA | 512x512 | SSAå¯¼è‡´FAå…¨æ˜¯å™ªç‚¹ | ç§»é™¤SSA,åŒUNet |
| v25 | å•UNet+æ‹¼æ¥ | 256x512 | åˆ†è¾¨ç‡å¤ªä½ | 512x512å…¨åˆ†è¾¨ç‡ |
| v26 | å•UNet+SSA | 512x512 | å¼ºåˆ¶è€¦åˆ+SSA | è§£è€¦+åŒUNet |
| **v27** | **åŒUNet** | **512x512** | **-** | **ç‹¬ç«‹å»ºæ¨¡+ç»“æ„çº¦æŸ** |

## ğŸ¤” FAQ

**Q: ä¸ºä»€ä¹ˆä¸ç”¨v22çš„ControlNetæ–¹æ¡ˆ?**
A: v22æ˜¯æ¡ä»¶ç”Ÿæˆ(éœ€è¦è¾“å…¥è¡€ç®¡å›¾+tileå›¾),æ— æ³•ä»çº¯å™ªå£°ç”Ÿæˆå…¨æ–°æ ·æœ¬ã€‚v27æ˜¯æ— æ¡ä»¶ç”Ÿæˆ,å¯ä»¥ç”Ÿæˆè®­ç»ƒé›†ä¸­ä¸å­˜åœ¨çš„æ–°ç»“æ„ã€‚

**Q: åŒUNetä¼šä¸ä¼šæ˜¾å­˜ä¸å¤Ÿ?**
A: ä½¿ç”¨LoRAåæ¯ä¸ªUNetåªæœ‰çº¦2.4Må¯è®­ç»ƒå‚æ•°,æ˜¾å­˜å ç”¨ä¸å¤§ã€‚å¦‚æœæ˜¾å­˜ç´§å¼ ,å¯ä»¥é™ä½batch sizeæˆ–LoRA rankã€‚

**Q: ç”Ÿæˆçš„CF-FAä¸€å®šç»“æ„å¯¹é½å—?**
A: ç»“æ„ä¸€è‡´æ€§æŸå¤±ä¼šå°½é‡çº¦æŸ,ä½†ä¸æ˜¯100%ä¿è¯ã€‚å¦‚æœå¯¹é½åº¦ä¸å¤Ÿ,å¯ä»¥å¢å¤§`--struct_lambda`ã€‚

**Q: å¯ä»¥åªè®­ç»ƒFAç”Ÿæˆå—?**
A: å¯ä»¥,ä½†ä¸æ¨èã€‚CF-FAè”åˆè®­ç»ƒå¯ä»¥é€šè¿‡ç»“æ„ä¸€è‡´æ€§çº¦æŸäº’ç›¸å¸®åŠ©,å•ç‹¬è®­ç»ƒFAå¯èƒ½æ•ˆæœæ›´å·®ã€‚

## ğŸ“§ é—®é¢˜åé¦ˆ

å¦‚æœè®­ç»ƒè¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜,è¯·æ£€æŸ¥:
1. æ•°æ®é›†è·¯å¾„æ˜¯å¦æ­£ç¡®
2. æ˜¾å­˜æ˜¯å¦è¶³å¤Ÿ (å»ºè®®24GB+)
3. training_log.txt ä¸­lossæ˜¯å¦æ­£å¸¸ä¸‹é™
4. step_XXXXXX_random_pairs ä¸­çš„å¯è§†åŒ–æ ·æœ¬è´¨é‡

ç¥è®­ç»ƒé¡ºåˆ©! ğŸ‰
